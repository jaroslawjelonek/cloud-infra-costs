resources:
  jobs:
    aws_cost_job:
      name: aws_cost_job
      email_notifications:
        on_failure:
          - ${var.job_alerts_email}
      schedule:
        quartz_cron_expression: 4 0 0 * * ?
        timezone_id: America/Chicago
        pause_status: UNPAUSED
      tasks:
        - task_key: 001_-_Metadata_Ingestion
          notebook_task:
            notebook_path: "../src/001-Metadata_Ingestion.ipynb"
            source: WORKSPACE
          max_retries: 2
          min_retry_interval_millis: 3600000
          retry_on_timeout: true
          disable_auto_optimization: false
          timeout_seconds: 1800
          health:
            rules:
              - metric: RUN_DURATION_SECONDS
                op: GREATER_THAN
                value: 300
        - task_key: 002_-_Foreach_Bronze_data_Ingestion
          depends_on:
            - task_key: 001_-_Metadata_Ingestion
          for_each_task:
            inputs: "{{tasks.`001_-_Metadata_Ingestion`.values.months_json}}"
            concurrency: 1
            task:
              task_key: 002_-_Bronze_data_Ingestion
              notebook_task:
                notebook_path: "../src/002-Bronze_table.ipynb"
                base_parameters:
                  billing_period: "{{input}}"
                source: WORKSPACE
              max_retries: 2
              min_retry_interval_millis: 600000
              disable_auto_optimization: false
              timeout_seconds: 7200
              health:
                rules:
                  - metric: RUN_DURATION_SECONDS
                    op: GREATER_THAN
                    value: 1800
        - task_key: 003-_Silver_Data
          depends_on:
            - task_key: 002_-_Foreach_Bronze_data_Ingestion
          for_each_task:
            inputs: "{{tasks.`001_-_Metadata_Ingestion`.values.months_json}}"
            concurrency: 1
            task:
              task_key: 003-_Silver_Data_iteration
              notebook_task:
                notebook_path: "../src/003-Silver_table.ipynb"
                base_parameters:
                  billing_period: "{{input}}"
                source: WORKSPACE
              max_retries: 2
              min_retry_interval_millis: 900000
              disable_auto_optimization: false
              timeout_seconds: 7200
              health:
                rules:
                  - metric: RUN_DURATION_SECONDS
                    op: GREATER_THAN
                    value: 1800
        - task_key: 004-_Gold_Data
          depends_on:
            - task_key: 003-_Silver_Data
          for_each_task:
            inputs: "{{tasks.`001_-_Metadata_Ingestion`.values.months_json}}"
            task:
              task_key: 004-_Gold_Data_iteration
              notebook_task:
                notebook_path: "../src/004-Gold_data.ipynb"
                base_parameters:
                  billing_period: "{{input}}"
                source: WORKSPACE
              max_retries: 2
              min_retry_interval_millis: 900000
              disable_auto_optimization: false
              timeout_seconds: 7200
              health:
                rules:
                  - metric: RUN_DURATION_SECONDS
                    op: GREATER_THAN
                    value: 1800
      queue:
        enabled: true
      parameters:
        - name: checkpoint_location
          default: /Volumes/${var.catalog}/${var.schema}/${var.volume_name}/checkpoints/aws_cost_and_usage_tracking
        - name: include_existing
          default: "true"
        - name: schema_location
          default: /Volumes/${var.catalog}/${var.schema}/${var.volume_name}/schemas/aws_cost_and_usage_tracking
        - name: source_location_metadata
          default: ${var.storage_location}metadata/
        - name: tracker_table_name
          default: ${var.tracker_table_name}
        - name: source_location_data
          default: ${var.storage_location}data/
        - name: target_catalog_name
          default: ${var.catalog}
        - name: target_schema_name
          default: ${var.schema}
        - name: bronze_table_name
          default: ${var.bronze_table_name}
        - name: silver_table_name
          default: ${var.silver_table_name}
        - name: gold_table_name
          default: ${var.gold_table_name}
        - name: volume_name
          default: ${var.volume_name}
      performance_target: STANDARD
